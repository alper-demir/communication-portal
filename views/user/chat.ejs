<!DOCTYPE html>
<html lang="en">

<%- include('../partials/head') %>

    <body>
        <div class="flex flex-wrap dark:bg-[#343541]">

            <div class="z-10 w-full">
                <%- include('../partials/navbar') %>
            </div>

            <%- include('../partials/side') %>
                <div class="flex-grow ml-64">
                    <input type="hidden" id="userId" value="<%= userId %>">
                    <input type="hidden" id="roomId" value="<%= roomId %>">
                    <input type="hidden" id="friendId" value="<%= friendId %>">
                    <div class="h-[85vh] mb-20 mt-5 dark:bg-[#343541]">
                        <div class="flex justify-center h-[85vh] relative">
                            <div class="bg-sky-200 dark:bg-[#5c5f75] dark:bg-opacity-20 w-3/5 py-8 overflow-y-auto rounded"
                                id="sc">

                                <div class="mb-10" id="messageList"></div>
                                <form id="messageForm" class="absolute bottom-1 flex px-2 w-3/5 mb-3">
                                    <input id="messageInput" type="text"
                                        class="rounded-2xl w-full mr-3 py-1 px-3 break-all">
                                    <button
                                        class="py-1 px-3 bg-sky-500 text-white dark:bg-cyan-800 rounded hover:opacity-80 mr-5">Send</button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div>
                        <%- include('../partials/footer') %>
                    </div>
                    
                </div>
    </body>

    <script src="/socket.io/socket.io.js"></script>
    <script src="../../public/js/getMessages.js"></script>

    <script>
        const sc = document.getElementById("sc")
        sc.scrollTo(0, sc.scrollHeight)

        const roomId = document.getElementById("roomId").value
        const friendId = document.getElementById("friendId").value
        const messageForm = document.getElementById('messageForm')
        const messageList = document.getElementById('messageList')
        const socket = io.connect();

        socket.on('connect', () => {
            console.log(`Connected to Socket.IO with ID: ${socket.id}`);
            socket.emit('joinRoom', roomId);
        });

        socket.on('message', (data) => {
            const messageList = document.getElementById("messageList")
            const div = document.createElement("div")
            const p = document.createElement("p")

            if (data.sender == document.getElementById("userId").value) {
                div.className = "flex justify-end px-4"
            }
            else {
                div.className = "flex px-4"
                const img = document.createElement("img")
                img.src = "../../public/images/<%= friendImage %>"
                img.className = "w-9 h-9 rounded-full object-cover mr-1 ring-1 ring-orange-500"
                div.appendChild(img)
            }
            p.className = "bg-green-100 dark:bg-[#444654] dark:text-white py-1 px-3 inline-block rounded-lg mb-4 max-w-[20rem]"
            p.innerText = `${data.message}`
            div.appendChild(p)
            messageList.appendChild(div)
            sc.scrollTo(0, sc.scrollHeight)
        })

        messageForm.addEventListener('submit', (event) => {

            event.preventDefault()

            const messageInput = document.getElementById("messageInput")
            if (messageInput.value.length > 0) {
                const userId = document.getElementById("userId").value
                const messageData = {
                    message: messageInput.value.trim(),
                    roomId: roomId,
                    sender: userId
                }
                console.log("message:", messageData.message)
                socket.emit('message', messageData);
                axios.post("/api/save-message", {
                    roomId: roomId,
                    senderId: userId,
                    receiverId: friendId,
                    message: messageInput.value.trim()
                })
                messageInput.value = ''
                sc.scrollTo(0, sc.scrollHeight)

            }
        })
    </script>

</html>